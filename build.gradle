import java.text.SimpleDateFormat

plugins {
    id 'java'
    id 'maven-publish'
    id 'idea'
}

allprojects {
    group = rootProject.maven_group
    version = rootProject.mod_version

    repositories {
        mavenCentral()
        maven {
            name = 'Fabric'
            url = 'https://maven.fabricmc.net/'
        }
        maven {
            name = 'NeoForge'
            url = 'https://maven.neoforged.net/releases'
        }
        maven {
            name = 'ParchmentMC'
            url = 'https://maven.parchmentmc.org'
        }
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'maven-publish'
    apply plugin: 'idea'

    java {
        withSourcesJar()
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.release = 21
        it.options.encoding = 'UTF-8'
    }

    idea {
        module {
            downloadSources = true
            downloadJavadoc = true
        }
    }
}

// === æ•°æ®ç”Ÿæˆä»»åŠ¡ ===

tasks.register('generateData') {
    group = 'data generation'
    description = 'Run data generation using Fabric (for both platforms)'

    dependsOn ':fabric:generateData'

    doFirst {
        println "â™»ï¸ å¼€å§‹ä½¿ç”¨ Fabric ç”Ÿæˆæ•°æ®ï¼ˆé€‚ç”¨äºåŒå¹³å°ï¼‰..."
    }

    doLast {
        println "âœ… Fabric æ•°æ®ç”Ÿæˆå®Œæˆï¼"

        // æ£€æŸ¥é€šç”¨ç”Ÿæˆç›®å½•
        def commonDataDir = project(':common').file('src/generated/resources')
        println "ğŸ“ é€šç”¨æ•°æ®ä½ç½®: ${commonDataDir}"

        // ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
        if (commonDataDir.exists()) {
            def fileCount = 0
            def dirCount = 0

            commonDataDir.eachFileRecurse { file ->
                if (file.isFile()) {
                    fileCount++
                } else if (file.isDirectory() && file != commonDataDir) {
                    dirCount++
                }
            }

            println "ğŸ“Š æ€»ç”Ÿæˆæ–‡ä»¶æ•°: ${fileCount}"
            println "ğŸ“ æ€»ç”Ÿæˆç›®å½•æ•°: ${dirCount}"

            // æ˜¾ç¤ºæ–‡ä»¶ç±»å‹ç»Ÿè®¡
            if (fileCount > 0) {
                def fileTypes = [:]
                commonDataDir.eachFileRecurse { file ->
                    if (file.isFile()) {
                        def ext = file.name.substring(file.name.lastIndexOf('.') + 1)
                        fileTypes[ext] = (fileTypes[ext] ?: 0) + 1
                    }
                }

                println "ğŸ“„ æ–‡ä»¶ç±»å‹ç»Ÿè®¡:"
                fileTypes.each { ext, count ->
                    println "   ${ext.toUpperCase()}: ${count} ä¸ª"
                }

                // æ˜¾ç¤ºé¡¶çº§ç›®å½•ç»“æ„
                println "ğŸ“ ç›®å½•ç»“æ„:"
                commonDataDir.eachDir { dir ->
                    def subFiles = []
                    dir.eachFileRecurse { file -> if (file.isFile()) subFiles << file }
                    println "   ğŸ“‚ ${dir.name}/ (${subFiles.size()} ä¸ªæ–‡ä»¶)"
                }
            }
        } else {
            println "âš ï¸ è­¦å‘Š: é€šç”¨æ•°æ®ç›®å½•ä¸å­˜åœ¨"
        }
    }
}

tasks.register('cleanGeneratedData') {
    group = 'data generation'
    description = 'Clean all generated data'

    dependsOn ':common:cleanGeneratedData'

    doLast {
        println "âœ… å·²æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ•°æ®"
    }
}

// === é€šç”¨æ„å»ºä»»åŠ¡ ===

afterEvaluate {
    // é€šç”¨æ¨¡ç»„ JARï¼ˆåŒ…å«åŒç«¯å®ç°ï¼‰
    tasks.register('buildUniversalJar', Jar) {
        archiveBaseName = "${rootProject.archives_name}"
        archiveVersion = rootProject.mod_version
        archiveClassifier = 'universal'
        destinationDirectory = layout.buildDirectory.dir('libs')

        // ä¾èµ–å…³ç³» - åªä½¿ç”¨ Fabric æ•°æ®ç”Ÿæˆ
        dependsOn ':fabric:build', ':neoforge:build', ':common:build', 'generateData'

        def fabricJarProvider = project(':fabric').tasks.named('remapJar').flatMap { it.archiveFile }
        def neoForgeJarProvider = project(':neoforge').tasks.named('jar').flatMap { it.archiveFile }
        def commonResourcesDir = project(':common').sourceSets.main.resources.srcDirs[0]

        // åŒ…å«é€šç”¨æ¨¡å—ç”Ÿæˆçš„æ•°æ®ï¼ˆç”± Fabric ç”Ÿæˆï¼‰
        from(project(':common').file('src/generated/resources')) {
            into 'assets'
            include '**/*'
        }

        // Fabric JAR å†…å®¹
        from(fabricJarProvider.map { zipTree(it) }) {
            exclude "${rootProject.mod_id}.mixins.json"
        }

        // NeoForge JAR å†…å®¹
        from(neoForgeJarProvider.map { zipTree(it) }) {
            exclude "${rootProject.mod_id}.mixins.json"
        }

        // Common èµ„æº
        from(commonResourcesDir) {
            include "${rootProject.mod_id}.mixins.json"
            exclude 'fabric.mod.json'
            exclude 'META-INF/mods.toml'
            exclude 'META-INF/neoforge.mods.toml'
        }

        duplicatesStrategy = DuplicatesStrategy.INCLUDE

        doFirst {
            println "â™»ï¸ å¼€å§‹æ„å»ºé€šç”¨æ¨¡ç»„ JAR..."
            println "ğŸ“¦ åŒ…å«: Fabric + NeoForge + Common + Fabricç”Ÿæˆçš„æ•°æ®"
            println "ğŸ“ æ•°æ®æ¥æº: Fabric æ•°æ®ç”Ÿæˆ -> é€šç”¨æ¨¡å—"
        }

        doLast {
            def jarFile = archiveFile.get().asFile
            def jarContents = zipTree(jarFile).files.name

            println "âœ… é€šç”¨æ¨¡ç»„ JAR æ„å»ºå®Œæˆ: ${jarFile.name}"
            println "ğŸ“¦ æ–‡ä»¶å¤§å°: ${String.format("%.2f", jarFile.length() / 1024.0 / 1024.0)} MB"

            // éªŒè¯å†…å®¹
            def hasFabricManifest = jarContents.contains('fabric.mod.json')
            def hasNeoForgeManifest = jarContents.contains('META-INF/neoforge.mods.toml')
            def hasMixins = jarContents.contains("${rootProject.mod_id}.mixins.json")
            def assetCount = jarContents.count { it.startsWith('assets/') }
            def dataCount = jarContents.count { it.startsWith('data/') }

            println "ğŸ” JAR å†…å®¹éªŒè¯:"
            println "   âœ… Fabric æ¸…å•: ${hasFabricManifest}"
            println "   âœ… NeoForge æ¸…å•: ${hasNeoForgeManifest}"
            println "   âœ… Mixins é…ç½®: ${hasMixins}"
            println "   ğŸ“ èµ„æºæ–‡ä»¶: ${assetCount} ä¸ª"
            println "   ğŸ“ æ•°æ®æ–‡ä»¶: ${dataCount} ä¸ª"

            // æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®
            def generatedAssets = jarContents.findAll {
                it.startsWith('assets/') &&
                        (it.contains('/lang/') || it.contains('/models/') || it.contains('/textures/') || it.contains('/blockstates/'))
            }
            println "   ğŸ¨ ç”Ÿæˆèµ„æº: ${generatedAssets.size()} ä¸ª"

            if (generatedAssets.size() > 0) {
                println "   ğŸ“„ ç”Ÿæˆèµ„æºç¤ºä¾‹:"
                generatedAssets.take(5).each { file ->
                    println "     - ${file}"
                }
            }
        }

        manifest {
            attributes(
                    'Multi-Release': 'true',
                    'Built-By': System.getProperty('user.name'),
                    'Build-Timestamp': new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
                    'Created-By': "Gradle ${gradle.gradleVersion}",
                    'Build-Jdk': "${System.getProperty('java.version')} (${System.getProperty('java.vendor')} ${System.getProperty('java.vm.version')})",
                    'Build-OS': "${System.getProperty('os.name')} ${System.getProperty('os.arch')} ${System.getProperty('os.version')}"
            )
        }
    }

    // é€šç”¨æºç  JAR
    tasks.register('buildUniversalSourceJar', Jar) {
        archiveBaseName = "${rootProject.archives_name}"
        archiveVersion = rootProject.mod_version
        archiveClassifier = 'universal-sources'
        destinationDirectory = layout.buildDirectory.dir('libs')

        dependsOn ':fabric:sourcesJar', ':neoforge:sourcesJar', ':common:sourcesJar'

        def fabricSourceJarProvider = project(':fabric').tasks.named('sourcesJar').flatMap { it.archiveFile }
        def neoForgeSourceJarProvider = project(':neoforge').tasks.named('sourcesJar').flatMap { it.archiveFile }
        def commonSourceJarProvider = project(':common').tasks.named('sourcesJar').flatMap { it.archiveFile }

        from(fabricSourceJarProvider.map { zipTree(it) })
        from(neoForgeSourceJarProvider.map { zipTree(it) })
        from(commonSourceJarProvider.map { zipTree(it) })

        duplicatesStrategy = DuplicatesStrategy.INCLUDE

        doLast {
            println "âœ… é€šç”¨æºç  JAR æ„å»ºå®Œæˆ"
        }
    }

    // å‘å¸ƒä»»åŠ¡
    tasks.register('release') {
        group = 'distribution'
        description = 'Build all distribution artifacts'

        dependsOn buildUniversalJar, buildUniversalSourceJar

        doLast {
            def libsDir = layout.buildDirectory.dir('libs').get().asFile
            println "ğŸ‰ æ‰€æœ‰å‘å¸ƒæ„ä»¶æ„å»ºå®Œæˆï¼"
            println "ğŸ“¦ ä½ç½®: ${libsDir}"

            libsDir.listFiles({ file -> file.name.endsWith('.jar') } as FileFilter)?.each { file ->
                def sizeMB = String.format("%.2f", file.length() / 1024.0 / 1024.0)
                println "   ğŸ“„ ${file.name} (${sizeMB} MB)"
            }
        }
    }
}

// === é¡¹ç›®ç®¡ç†ä»»åŠ¡ ===

tasks.register('buildAll') {
    group = 'build'
    description = 'Build all subprojects and create universal jars'

    dependsOn 'fabric:build', 'neoforge:build', 'common:build', 'buildUniversalJar', 'buildUniversalSourceJar'

    doLast {
        println "âœ… æ‰€æœ‰æ¨¡å—æ„å»ºå®Œæˆ"

        def libsDir = layout.buildDirectory.dir('libs').get().asFile
        def jars = libsDir.listFiles({ file -> file.name.endsWith('.jar') } as FileFilter)

        println "ğŸ“¦ ç”Ÿæˆçš„ JAR æ–‡ä»¶:"
        jars?.each { file ->
            def sizeMB = String.format("%.2f", file.length() / 1024.0 / 1024.0)
            println "   ğŸ“„ ${file.name} (${sizeMB} MB)"
        }
    }
}

tasks.register('projectInfo') {
    group = 'help'
    description = 'Display project information'

    doLast {
        println """
ğŸ¯ é¡¹ç›®ä¿¡æ¯:
   åç§°: ${rootProject.name}
   ç»„: ${rootProject.maven_group}
   ç‰ˆæœ¬: ${rootProject.mod_version}
   Minecraft: ${rootProject.minecraft_version}

ğŸ› ï¸ å¯ç”¨ä»»åŠ¡:
   ğŸ“Š generateData       - ä½¿ç”¨ Fabric ç”Ÿæˆæ•°æ®ï¼ˆåŒå¹³å°å…±äº«ï¼‰
   ğŸ“¦ buildUniversalJar  - æ„å»ºé€šç”¨æ¨¡ç»„ JAR
   ğŸš€ release            - æ„å»ºæ‰€æœ‰å‘å¸ƒæ„ä»¶
   ğŸ”¨ buildAll           - æ„å»ºæ‰€æœ‰æ¨¡å—
   ğŸ§¹ cleanGeneratedData - æ¸…ç†ç”Ÿæˆçš„æ•°æ®

ğŸ’¡ å¿«é€Ÿå¼€å§‹:
   ./gradlew generateData       # ç”Ÿæˆæ•°æ®ï¼ˆFabricï¼‰
   ./gradlew buildUniversalJar  # æ„å»ºé€šç”¨ JAR
   ./gradlew release            # å®Œæ•´å‘å¸ƒ

ğŸ“ æ³¨æ„:
   å½“å‰ä½¿ç”¨ Fabric æ•°æ®ç”Ÿæˆå™¨ä¸ºåŒå¹³å°ç”Ÿæˆæ•°æ®
   NeoForge æ•°æ®ç”Ÿæˆå·²ç¦ç”¨
        """
    }
}

// é…ç½®é»˜è®¤ä»»åŠ¡
defaultTasks 'projectInfo'