import java.text.SimpleDateFormat

plugins {
    id 'java'
    id 'maven-publish'
}

allprojects {
    group = rootProject.maven_group
    version = rootProject.mod_version

    repositories {
        mavenCentral()
        maven {
            name = 'Fabric'
            url = 'https://maven.fabricmc.net/'
        }
        maven {
            name = 'NeoForge'
            url = 'https://maven.neoforged.net/releases'
        }
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'maven-publish'  // ä¿®å¤ï¼šæ”¹ä¸ºæ­£ç¡®çš„æ’ä»¶ID

    java {
        withSourcesJar()
        sourceCompatibility = JavaVersion.VERSION_21
        targetCompatibility = JavaVersion.VERSION_21
    }

    tasks.withType(JavaCompile).configureEach {
        it.options.release = 21
        it.options.encoding = 'UTF-8'
    }
}

// ä½¿ç”¨å»¶è¿Ÿé…ç½®æ¥è§£å†³ä»»åŠ¡å¼•ç”¨é—®é¢˜
afterEvaluate {
    // åˆ›å»ºæ™ºèƒ½å¤šç«¯åˆå¹¶Jarä»»åŠ¡
    tasks.register('buildUniversalJar', Jar) {
        archiveBaseName = "${rootProject.archives_name}"
        archiveVersion = rootProject.mod_version
        archiveClassifier = 'universal'
        // ä½¿ç”¨æ–°çš„ç›®å½•APIè®¾ç½®ç›®æ ‡ç›®å½•
        destinationDirectory = layout.buildDirectory.dir('libs')

        // ä½¿ç”¨ä»»åŠ¡ä¾èµ–è€Œä¸æ˜¯ç›´æ¥å¼•ç”¨ä»»åŠ¡å¯¹è±¡
        dependsOn ':fabric:build', ':neoforge:build', ':common:build'

        // åœ¨é…ç½®é˜¶æ®µè®¾ç½®æ–‡ä»¶æ¥æºï¼Œè€Œä¸æ˜¯åœ¨æ‰§è¡Œé˜¶æ®µ
        def fabricJarProvider = project(':fabric').tasks.named('remapJar').flatMap { it.archiveFile }
        def neoForgeJarProvider = project(':neoforge').tasks.named('jar').flatMap { it.archiveFile }
        def commonResourcesDir = project(':common').sourceSets.main.resources.srcDirs[0]

        // é…ç½®Fabric JARå†…å®¹ - åŒ…å«fabric.mod.json
        from(fabricJarProvider.map { zipTree(it) }) {
            // ä¸å†æ’é™¤Fabricç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼Œç¡®ä¿fabric.mod.jsonè¢«æ‰“åŒ…
            // åªæ’é™¤å¯èƒ½å†²çªçš„æ–‡ä»¶
            exclude "${rootProject.mod_id}.mixins.json" // ä½¿ç”¨Commonçš„é€šç”¨ç‰ˆæœ¬
        }

        // é…ç½®NeoForge JARå†…å®¹ - åŒ…å«neoforge.mods.toml
        from(neoForgeJarProvider.map { zipTree(it) }) {
            // ä¸å†æ’é™¤NeoForgeç‰¹å®šçš„é…ç½®æ–‡ä»¶ï¼Œç¡®ä¿neoforge.mods.tomlè¢«æ‰“åŒ…
            // åªæ’é™¤å¯èƒ½å†²çªçš„æ–‡ä»¶
            exclude "${rootProject.mod_id}.mixins.json" // ä½¿ç”¨Commonçš„é€šç”¨ç‰ˆæœ¬
        }

        // æ·»åŠ Commonæ¨¡å—çš„èµ„æºæ–‡ä»¶ - åŒ…å«é€šç”¨çš„mixins.json
        from(commonResourcesDir) {
            // ç¡®ä¿é€šç”¨çš„mixinsé…ç½®æ–‡ä»¶è¢«åŒ…å«
            include "${rootProject.mod_id}.mixins.json"
            // æ’é™¤å¹³å°ç‰¹å®šçš„æ¸…å•æ–‡ä»¶ï¼Œé¿å…å†²çª
            exclude 'fabric.mod.json'
            exclude 'META-INF/mods.toml'
            exclude 'META-INF/neoforge.mods.toml'
        }

        // å¤„ç†é‡å¤æ–‡ä»¶ - ä½¿ç”¨ç¬¬ä¸€ä¸ªé‡åˆ°çš„
        duplicatesStrategy = DuplicatesStrategy.INCLUDE

        doFirst {
            println "â™»ï¸å¼€å§‹æ„å»ºé€šç”¨æ¨¡ç»„jar..."
            println "â‡ï¸Fabric jar: ${fabricJarProvider.get()}"
            println "â‡ï¸NeoForge jar: ${neoForgeJarProvider.get()}"
            println "â‡ï¸Commonèµ„æºç›®å½•: ${commonResourcesDir}"

            // æ£€æŸ¥Commonèµ„æºç›®å½•å†…å®¹
            if (commonResourcesDir.exists()) {
                def resourceFiles = commonResourcesDir.listFiles()
                println "â‡ï¸Commonèµ„æºæ–‡ä»¶: ${resourceFiles?.collect { it.name } ?: 'æ— '}"
            } else {
                println "âš ï¸è­¦å‘Š: Commonèµ„æºç›®å½•ä¸å­˜åœ¨ ${commonResourcesDir}"
            }
        }

        doLast {
            println "âœ…é€šç”¨æ¨¡ç»„jaræ„å»ºå®Œæˆ: ${archiveFile.get()}"
            println "â‡ï¸æ–‡ä»¶å¤§å°: ${archiveFile.get().asFile.length()} bytes"

            // éªŒè¯ç”Ÿæˆçš„JARå†…å®¹
            println "â™»ï¸JARå†…å®¹éªŒè¯:"
            def jarFile = archiveFile.get().asFile
            def jarContents = zipTree(jarFile).files.name

            // æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            def fabricManifest = jarContents.contains('fabric.mod.json')
            def neoForgeManifest = jarContents.contains('META-INF/neoforge.mods.toml') || jarContents.contains('META-INF/mods.toml')
            def mixinsFile = jarContents.contains("${rootProject.mod_id}.mixins.json")

            println "â‡ï¸Fabricæ¸…å•æ–‡ä»¶: ${fabricManifest ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"
            println "â‡ï¸NeoForgeæ¸…å•æ–‡ä»¶: ${neoForgeManifest ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"
            println "â‡ï¸Mixinsé…ç½®æ–‡ä»¶: ${mixinsFile ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"

            // æ£€æŸ¥èµ„æºæ–‡ä»¶
            def resourceFiles = jarContents.findAll {
                it.startsWith('assets/') || it.startsWith('data/') ||
                        it.endsWith('.png') || it.endsWith('.json') && !it.endsWith('.mixins.json')
            }
            println "â‡ï¸èµ„æºæ–‡ä»¶æ•°é‡: ${resourceFiles.size()}"

            // æ˜¾ç¤ºéƒ¨åˆ†èµ„æºæ–‡ä»¶ä½œä¸ºç¤ºä¾‹
            if (resourceFiles.size() > 0) {
                println "â‡ï¸éƒ¨åˆ†èµ„æºæ–‡ä»¶ç¤ºä¾‹:"
                resourceFiles.take(10).each { file ->
                    println "   - ${file}"
                }
                if (resourceFiles.size() > 10) {
                    println "   ... è¿˜æœ‰ ${resourceFiles.size() - 10} ä¸ªæ–‡ä»¶"
                }
            }

            def conflictingFiles = jarContents.groupBy { it }.findAll { it.value.size() > 1 }.keySet()
            if (conflictingFiles) {
                println "âš ï¸è­¦å‘Š: å‘ç°é‡å¤æ–‡ä»¶: ${conflictingFiles}"
            } else {
                println "âœ…æ²¡æœ‰æ–‡ä»¶å†²çª"
            }
        }

        manifest {
            attributes(
                    'Multi-Release': 'true',
                    'Built-By': System.getProperty('user.name'),
                    'Build-Timestamp': new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
                    'Created-By': "Gradle ${gradle.gradleVersion}",
                    'Build-Jdk': "${System.getProperty('java.version')} (${System.getProperty('java.vendor')} ${System.getProperty('java.vm.version')})",
                    'Build-OS': "${System.getProperty('os.name')} ${System.getProperty('os.arch')} ${System.getProperty('os.version')}"
            )
        }
    }

    // åˆ›å»ºé€šç”¨æºç Jarä»»åŠ¡
    tasks.register('buildUniversalSourceJar', Jar) {
        archiveBaseName = "${rootProject.archives_name}"
        archiveVersion = rootProject.mod_version
        archiveClassifier = 'universal-sources'
        destinationDirectory = layout.buildDirectory.dir('libs')

        // ä¾èµ–æ‰€æœ‰å­é¡¹ç›®çš„æºç Jarä»»åŠ¡
        dependsOn ':fabric:sourcesJar', ':neoforge:sourcesJar', ':common:sourcesJar'

        // è·å–æ‰€æœ‰å­é¡¹ç›®çš„æºç Jar
        def fabricSourceJarProvider = project(':fabric').tasks.named('sourcesJar').flatMap { it.archiveFile }
        def neoForgeSourceJarProvider = project(':neoforge').tasks.named('sourcesJar').flatMap { it.archiveFile }
        def commonSourceJarProvider = project(':common').tasks.named('sourcesJar').flatMap { it.archiveFile }

        // åˆå¹¶æ‰€æœ‰æºç Jar
        from(fabricSourceJarProvider.map { zipTree(it) })
        from(neoForgeSourceJarProvider.map { zipTree(it) })
        from(commonSourceJarProvider.map { zipTree(it) })

        // å¤„ç†é‡å¤æ–‡ä»¶
        duplicatesStrategy = DuplicatesStrategy.INCLUDE

        doFirst {
            println "â™»ï¸å¼€å§‹æ„å»ºé€šç”¨æºç jar..."
            println "â‡ï¸Fabric æºç : ${fabricSourceJarProvider.get()}"
            println "â‡ï¸NeoForge æºç : ${neoForgeSourceJarProvider.get()}"
            println "â‡ï¸Common æºç : ${commonSourceJarProvider.get()}"
        }

        doLast {
            println "âœ…é€šç”¨æºç jaræ„å»ºå®Œæˆ: ${archiveFile.get()}"
            println "â‡ï¸æ–‡ä»¶å¤§å°: ${archiveFile.get().asFile.length()} bytes"

            // éªŒè¯æºç JARå†…å®¹
            def jarFile = archiveFile.get().asFile
            def jarContents = zipTree(jarFile).files.name
            def javaFiles = jarContents.findAll { it.endsWith('.java') }
            println "â‡ï¸åŒ…å«Javaæºæ–‡ä»¶æ•°é‡: ${javaFiles.size()}"
        }

        manifest {
            attributes(
                    'Built-By': System.getProperty('user.name'),
                    'Build-Timestamp': new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
                    'Created-By': "Gradle ${gradle.gradleVersion}",
                    'Build-Jdk': "${System.getProperty('java.version')} (${System.getProperty('java.vendor')} ${System.getProperty('java.vm.version')})",
                    'Build-OS': "${System.getProperty('os.name')} ${System.getProperty('os.arch')} ${System.getProperty('os.version')}"
            )
        }
    }

    // é…ç½®ä»»åŠ¡ç»„
    tasks.named('buildUniversalJar') {
        group = 'distribution'
        description = 'Builds a universal jar containing both Fabric and NeoForge implementations'
    }

    tasks.named('buildUniversalSourceJar') {
        group = 'distribution'
        description = 'Builds a universal source jar containing sources from all platforms'
    }

    tasks.register('release') {
        group = 'distribution'
        description = 'Build all distribution artifacts'

        dependsOn buildUniversalJar, buildUniversalSourceJar

        doLast {
            println "âœ…æ‰€æœ‰å‘å¸ƒæ„ä»¶æ„å»ºå®Œæˆï¼"
            // ä½¿ç”¨æ–°çš„ç›®å½•APIæ›¿ä»£å·²å¼ƒç”¨çš„buildDir
            def libsDir = layout.buildDirectory.dir('libs').get().asFile
            println "â‡ï¸ä½ç½®: ${libsDir}"
            println "ğŸ“¦å¯ç”¨æ„ä»¶:"
            libsDir.listFiles({ file -> file.name.endsWith('.jar') } as FileFilter)?.each { file ->
                println "  - ${file.name} (${file.length()} bytes)"
            }
        }
    }
}

// æ·»åŠ ä¸€ä¸ªå®‰å…¨çš„é€šç”¨æ„å»ºä»»åŠ¡ï¼Œä¸ä¾èµ–ç‰¹å®šå­é¡¹ç›®ä»»åŠ¡
tasks.register('buildAll') {
    group = 'build'
    description = 'Build all subprojects and create universal jars'

    dependsOn 'fabric:build', 'neoforge:build', 'common:build', 'buildUniversalJar', 'buildUniversalSourceJar'

    doLast {
        println "âœ…æ‰€æœ‰æ¨¡å—æ„å»ºå®Œæˆ"
        // ä½¿ç”¨æ–°çš„ç›®å½•APIæ›¿ä»£å·²å¼ƒç”¨çš„buildDir
        def buildDir = layout.buildDirectory.get().asFile
        println "âœ…æ„å»ºç›®å½•: ${buildDir}"

        def libsDir = layout.buildDirectory.dir('libs').get().asFile
        println "ğŸ“¦ç”Ÿæˆçš„JARæ–‡ä»¶:"
        libsDir.listFiles({ file -> file.name.endsWith('.jar') } as FileFilter)?.each { file ->
            println "  - ${file.name} (${file.length()} bytes)"
        }
    }
}

// æ·»åŠ ä¸€ä¸ªä»»åŠ¡æ¥æ„å»ºæ‰€æœ‰æºç Jar
tasks.register('buildAllSources') {
    group = 'build'
    description = 'Build all source jars including universal source jar'

    dependsOn 'fabric:sourcesJar', 'neoforge:sourcesJar', 'common:sourcesJar', 'buildUniversalSourceJar'

    doLast {
        println "âœ…æ‰€æœ‰æºç Jaræ„å»ºå®Œæˆ"

        // æ˜¾ç¤ºæ‰€æœ‰æºç Jarçš„ä½ç½®
        def libsDir = layout.buildDirectory.dir('libs').get().asFile
        println "ğŸ“¦æºç JARæ–‡ä»¶:"
        libsDir.listFiles({ file -> file.name.contains('sources') && file.name.endsWith('.jar') } as FileFilter)?.each { file ->
            println "  - ${file.name} (${file.length()} bytes)"
        }
    }
}

// æ·»åŠ ä¸€ä¸ªæ£€æŸ¥ä»»åŠ¡ï¼ŒéªŒè¯å­é¡¹ç›®é…ç½®
tasks.register('verifySubprojects') {
    doLast {
        println "â™»ï¸éªŒè¯å­é¡¹ç›®é…ç½®..."

        // æ£€æŸ¥fabricé¡¹ç›®æ˜¯å¦å­˜åœ¨remapJarä»»åŠ¡
        if (project.childProjects.containsKey('fabric')) {
            def fabricProject = project.childProjects['fabric']
            if (fabricProject.tasks.named('remapJar')) {
                println "âœ…Fabricé¡¹ç›®é…ç½®æ­£ç¡®"
                // ä½¿ç”¨æ–°çš„ç›®å½•APIæ£€æŸ¥è¾“å‡º
                def fabricBuildDir = fabricProject.layout.buildDirectory.get().asFile
                println "â‡ï¸Fabricæ„å»ºç›®å½•: ${fabricBuildDir}"

                // æ£€æŸ¥Fabricèµ„æº
                def fabricResources = fabricProject.sourceSets.main.resources.srcDirs
                println "â‡ï¸Fabricèµ„æºç›®å½•: ${fabricResources}"

                // æ£€æŸ¥fabric.mod.jsonæ˜¯å¦å­˜åœ¨
                def fabricModJson = new File(fabricProject.projectDir, "src/main/resources/fabric.mod.json")
                println "â‡ï¸fabric.mod.json: ${fabricModJson.exists() ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"
            } else {
                println "âŒFabricé¡¹ç›®ç¼ºå°‘remapJarä»»åŠ¡"
            }
        } else {
            println "âŒæ‰¾ä¸åˆ°Fabricå­é¡¹ç›®"
        }

        // æ£€æŸ¥neoforgeé¡¹ç›®æ˜¯å¦å­˜åœ¨jarä»»åŠ¡
        if (project.childProjects.containsKey('neoforge')) {
            def neoForgeProject = project.childProjects['neoforge']
            if (neoForgeProject.tasks.named('jar')) {
                println "âœ…NeoForgeé¡¹ç›®é…ç½®æ­£ç¡®"
                // ä½¿ç”¨æ–°çš„ç›®å½•APIæ£€æŸ¥è¾“å‡º
                def neoForgeBuildDir = neoForgeProject.layout.buildDirectory.get().asFile
                println "â‡ï¸NeoForgeæ„å»ºç›®å½•: ${neoForgeBuildDir}"

                // æ£€æŸ¥NeoForgeèµ„æº
                def neoForgeResources = neoForgeProject.sourceSets.main.resources.srcDirs
                println "â‡ï¸NeoForgeèµ„æºç›®å½•: ${neoForgeResources}"

                // æ£€æŸ¥neoforge.mods.tomlæ˜¯å¦å­˜åœ¨
                def neoForgeModsToml = new File(neoForgeProject.projectDir, "src/main/resources/META-INF/neoforge.mods.toml")
                def modsToml = new File(neoForgeProject.projectDir, "src/main/resources/META-INF/mods.toml")
                println "â‡ï¸NeoForgeæ¸…å•æ–‡ä»¶: ${neoForgeModsToml.exists() || modsToml.exists() ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"
            } else {
                println "âŒNeoForgeé¡¹ç›®ç¼ºå°‘jarä»»åŠ¡"
            }
        } else {
            println "âŒæ‰¾ä¸åˆ°NeoForgeå­é¡¹ç›®"
        }

        // æ£€æŸ¥commoné¡¹ç›®
        if (project.childProjects.containsKey('common')) {
            def commonProject = project.childProjects['common']
            println "âœ…Commoné¡¹ç›®é…ç½®æ­£ç¡®"
            // ä½¿ç”¨æ–°çš„ç›®å½•APIæ£€æŸ¥è¾“å‡º
            def commonBuildDir = commonProject.layout.buildDirectory.get().asFile
            println "â‡ï¸Commonæ„å»ºç›®å½•: ${commonBuildDir}"

            // æ£€æŸ¥Commonèµ„æº
            def commonResources = commonProject.sourceSets.main.resources.srcDirs
            println "â‡ï¸Commonèµ„æºç›®å½•: ${commonResources}"

            // åˆ—å‡ºCommonèµ„æºæ–‡ä»¶
            def commonResourceDir = commonProject.sourceSets.main.resources.srcDirs[0]
            if (commonResourceDir.exists()) {
                def resourceFiles = commonResourceDir.listFiles()
                println "â‡ï¸Commonèµ„æºæ–‡ä»¶: ${resourceFiles?.collect { it.name } ?: 'æ— '}"

                // æ£€æŸ¥mixins.jsonæ˜¯å¦å­˜åœ¨
                def mixinsJson = new File(commonResourceDir, "${rootProject.mod_id}.mixins.json")
                println "â‡ï¸Common mixins.json: ${mixinsJson.exists() ? 'âœ…å­˜åœ¨' : 'âŒç¼ºå¤±'}"
            } else {
                println "âš ï¸è­¦å‘Š: Commonèµ„æºç›®å½•ä¸å­˜åœ¨ ${commonResourceDir}"
            }
        } else {
            println "âŒæ‰¾ä¸åˆ°Commonå­é¡¹ç›®"
        }

        // æ£€æŸ¥æ‰€æœ‰å­é¡¹ç›®æ˜¯å¦æœ‰sourcesJarä»»åŠ¡
        project.childProjects.each { name, subproject ->
            if (subproject.tasks.named('sourcesJar')) {
                println "âœ…${name}é¡¹ç›®é…ç½®äº†sourcesJarä»»åŠ¡"
            } else {
                println "âŒ${name}é¡¹ç›®ç¼ºå°‘sourcesJarä»»åŠ¡"
            }
        }
    }
}

// æ·»åŠ ä¸€ä¸ªä»»åŠ¡æ¥æ˜¾ç¤ºæ„å»ºç›®å½•ä¿¡æ¯
tasks.register('buildInfo') {
    group = 'help'
    description = 'Display build directory information'

    doLast {
        println "â‡ï¸æ„å»ºç›®å½•ä¿¡æ¯:"
        println "âœ…æ ¹é¡¹ç›®æ„å»ºç›®å½•: ${layout.buildDirectory.get().asFile}"

        project.childProjects.each { name, subproject ->
            println "âœ…${name} å­é¡¹ç›®æ„å»ºç›®å½•: ${subproject.layout.buildDirectory.get().asFile}"
        }
    }
}