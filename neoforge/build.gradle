plugins {
    id 'java-library'
    id 'maven-publish'
    id 'net.neoforged.moddev' version '2.0.115'
    id 'idea'
}

version = mod_version
group = maven_group

base {
    archivesName = "${rootProject.archives_name}-neoforge"
}

java {
    toolchain.languageVersion = JavaLanguageVersion.of(21)
    withSourcesJar()
}

// æ¸…ç†ä»»åŠ¡
tasks.register('cleanModDevCache', Delete) {
    delete 'build/moddev'
}

// NeoForge é…ç½®
neoForge {
    version = rootProject.neo_version

    parchment {
        mappingsVersion = rootProject.parchment_mappings_version
        minecraftVersion = rootProject.parchment_minecraft_version
    }

    runs {
        client {
            client()
            systemProperty 'neoforge.enabledGameTestNamespaces', "${mod_id}"
            programArgument '--username=Dev'
        }

        server {
            server()
            programArgument '--nogui'
            systemProperty 'neoforge.enabledGameTestNamespaces', "${mod_id}"
        }

        gameTestServer {
            type = "gameTestServer"
            systemProperty 'neoforge.enabledGameTestNamespaces', "${mod_id}"
        }

        // ç§»é™¤æ•°æ®ç”Ÿæˆé…ç½® - ä½¿ç”¨ Fabric ç”Ÿæˆçš„æ•°æ®
    }

    mods {
        "${mod_id}" {
            sourceSet(sourceSets.main)
        }
    }
}

repositories {
    maven {
        name = 'NeoForge'
        url = 'https://maven.neoforged.net/releases'
    }
    maven {
        name = 'ParchmentMC'
        url = 'https://maven.parchmentmc.org'
    }
}

configurations {
    runtimeClasspath.extendsFrom localRuntime
}

dependencies {
    implementation project(":common")
}

// æºé›†é…ç½® - åŒ…å«é€šç”¨ç”Ÿæˆæ•°æ®ï¼ˆç”± Fabric ç”Ÿæˆï¼‰
sourceSets.main.resources.srcDir '../common/src/generated/resources'

// æ¨¡ç»„å…ƒæ•°æ®ç”Ÿæˆ
tasks.register("generateModMetadata", ProcessResources) {
    var replaceProperties = [
            minecraft_version: rootProject.minecraft_version,
            minecraft_version_range: rootProject.minecraft_version_range,
            neo_version: rootProject.neo_version,
            loader_version_range: rootProject.loader_version_range,
            mod_id: rootProject.mod_id,
            mod_name: rootProject.mod_name,
            mod_license: rootProject.mod_license,
            mod_version: rootProject.mod_version,
            mod_authors: rootProject.mod_authors,
            mod_description: rootProject.mod_description
    ]
    inputs.properties replaceProperties
    expand replaceProperties
    from "src/main/templates"
    into "build/generated/sources/modMetadata"
}

sourceSets.main.resources.srcDir tasks.generateModMetadata
neoForge.ideSyncTask tasks.generateModMetadata

// ç¼–è¯‘é…ç½®
tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

tasks.named('compileJava') {
    dependsOn(':common:compileJava')
}

// æ¸…ç†ä»»åŠ¡
tasks.named('clean') {
    dependsOn 'cleanModDevCache'
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            artifactId = base.archivesName.get()
            from components.java
        }
    }
}

// IDE é…ç½®
idea {
    module {
        downloadSources = true
        downloadJavadoc = true
        generatedSourceDirs += file('../common/src/generated/resources')
    }
}

// ä¿¡æ¯ä»»åŠ¡
tasks.register('dataGenInfo') {
    group = 'help'
    description = 'Display data generation information'

    doLast {
        println """
ğŸ“Š æ•°æ®ç”Ÿæˆä¿¡æ¯:
   å½“å‰é…ç½®: ä½¿ç”¨ Fabric æ•°æ®ç”Ÿæˆå™¨ä¸ºåŒå¹³å°ç”Ÿæˆæ•°æ®
   æ•°æ®ä½ç½®: ../common/src/generated/resources
   
ğŸ’¡ ä½¿ç”¨æ–¹æ³•:
   ./gradlew generateData     # è¿è¡Œ Fabric æ•°æ®ç”Ÿæˆ
   ./gradlew fabric:generateData  # åŒä¸Š
   
ğŸ“ æ³¨æ„:
   NeoForge æ•°æ®ç”Ÿæˆå·²ç¦ç”¨
   æ‰€æœ‰å¹³å°å…±äº« Fabric ç”Ÿæˆçš„æ•°æ®
        """
    }
}